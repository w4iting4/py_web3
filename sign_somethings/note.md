# sign ç­¾å
## æ¦‚è¿°
è¿™ä¸€èŠ‚æ˜¯ä¸ºäº†è§£å†³åœ¨äº¤æ˜“æˆ–è€…åˆçº¦äº¤äº’æˆ–è€…ç™»é™†é’±åŒ…çš„è¿‡ç¨‹ä¸­é‡åˆ°å¯¹æŸä¸ªæ¶ˆæ¯è¿›è¡Œç­¾åæˆ–è€…å¯¹äº¤æ˜“è¿›è¡Œç­¾åçš„é—®é¢˜.  
>è¿™ä¸€èŠ‚ä¸ºä»€ä¹ˆè¢«æˆ‘å•ç‹¬æ‹¿å‡ºæ¥ï¼Œæ˜¯å› ä¸ºä¹‹å‰åœ¨åˆ†ææŸä¸ªé¡¹ç›®çš„æ—¶å€™ï¼Œéœ€è¦ç™»é™†é’±åŒ…ã€‚è€Œç™»é™†é’±åŒ…çš„è¯·æ±‚åˆ™æ˜¯é€šè¿‡è‡ªå·±çš„ç§é’¥ï¼Œå¯¹æŸä¸ªæ¶ˆæ¯è¿›è¡Œç­¾åå°±è¡Œäº†ã€‚ä½†æ˜¯å½“æ—¶ä¸ä¼šï¼Œé€šè¿‡yakæŠ“åˆ°åŒ…äº†ä½†ä¸çŸ¥é“æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚åªèƒ½è¯´å¯æƒœã€‚

## å¯¹æŸä¸ªæ¶ˆæ¯ç­¾å
å½“æ—¶çš„åœºæ™¯ï¼š  
![img.png](img.png)  
è€Œç°åœ¨å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ç‚¹æ˜¯å¯ä»¥é€šè¿‡é’±åŒ…è·å–åˆ°è¦ç­¾åçš„æ¶ˆæ¯å†…å®¹ï¼Œç¬¬äºŒåˆ™æ˜¯å¯ä»¥é€šè¿‡jsè°ƒè¯•ï¼Œæ¥è·å–åˆ°ç›®æ ‡çš„æ¶ˆæ¯.  
æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å°è¯•é€šè¿‡ä»£ç æ¥å¯¹æ¶ˆæ¯è¿›è¡Œç­¾åäº†ï¼Œå‡è®¾å½“å‰çš„æ¶ˆæ¯å†…å®¹æ˜¯`313 fuck free world`,ç„¶åä½¿ç”¨ä¹‹å‰æ³¨å†Œçš„è´¦å·çš„åœ°å€å’Œç§é’¥ã€‚
```python
import web3
from web3 import Web3
from eth_account.messages import encode_defunct

msg = "313 fuck free world"
wallet_address1 = '0x99E83432EF5a04b68d39Eda395d71BE25359BD18'  # æœ‰ä½™é¢çš„æµ‹è¯•åœ°å€
wallet_address1_pvk = '0x6807f8e3b44b762dcc00562373bb921be5c1adeab0e68baac77d375c4403eb9b'  # å½“å‰åœ°å€çš„ç§é’¥

eth_test = Web3(Web3.HTTPProvider('https://rpc.sepolia.org/'))
print(f'è¿æ¥æµ‹è¯•ç½‘: {"æˆåŠŸ" if eth_test.is_connected() else "å¤±è´¥"}')

msg = encode_defunct(text=msg)
print(f'æ ¼å¼åŒ–åçš„msg {msg}')

signed_msg = eth_test.eth.account.sign_message(msg,wallet_address1_pvk)
print(f'ç­¾ååçš„msg {signed_msg}')
print(f'ç­¾ååçš„msgç±»å‹æ˜¯ {type(signed_msg)}')

è¿æ¥æµ‹è¯•ç½‘: æˆåŠŸ
æ ¼å¼åŒ–åçš„msg SignableMessage(version=b'E', header=b'thereum Signed Message:\n19', body=b'313 fuck free world')
ç­¾ååçš„msg SignedMessage(messageHash=HexBytes('0xdc57723ea9b324b77eea04067365e1854e0b516241e87c29a4d1f255e0e1a8ed'), r=13587921379995412209738732335311718851715483528391733152153635963832332854950, s=21162271105333464024059448134248284813940006022343777601273231027790247425195, v=28, signature=HexBytes('0x1e0a7daf93cdedd18811c1140e89e635cb28939fce18211fc69e8235faf626a62ec96bc576d439b4ef2b1b7e94a335d261bfb9ee238105def476a8204334f4ab1c'))
ç­¾ååçš„msgç±»å‹æ˜¯ <class 'eth_account.datastructures.SignedMessage'>
```
è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªæ¶ˆæ¯çš„ç­¾åã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¾“å‡ºçš„å¯¹è±¡å±æ€§è¿›è¡Œè§£æã€‚
>**messageHash**: è¿™æ˜¯æ¶ˆæ¯çš„å“ˆå¸Œå€¼ã€‚åœ¨ç­¾åè¿‡ç¨‹ä¸­ï¼ŒåŸå§‹æ¶ˆæ¯é¦–å…ˆè¢«å“ˆå¸ŒåŒ–ï¼ˆé€šå¸¸ä½¿ç”¨Keccak-256å“ˆå¸Œç®—æ³•ï¼‰ï¼Œä»¥ç”Ÿæˆä¸€ä¸ªå›ºå®šå¤§å°çš„å“ˆå¸Œå€¼ã€‚è¿™ä¸ªå“ˆå¸Œå€¼ä»£è¡¨äº†åŸå§‹æ¶ˆæ¯ï¼Œå¹¶ç”¨äºç­¾åè¿‡ç¨‹ã€‚  
r, s, v: è¿™äº›æ˜¯æ„æˆECDSAç­¾åçš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ã€‚
r: æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä»æ¤­åœ†æ›²çº¿ç‚¹ä¹˜è¿ç®—çš„ç»“æœä¸­å¾—å‡ºçš„ã€‚  
s: ä¹Ÿæ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯å…³äºç§é’¥ã€æ¶ˆæ¯å“ˆå¸Œå€¼ä»¥åŠrçš„è¿ç®—ç»“æœã€‚  
v: è¿™æ˜¯ç­¾åçš„æ¢å¤IDï¼Œç”¨äºä»ç­¾åä¸­æ¢å¤å‡ºå‘é€è€…çš„åœ°å€ã€‚åœ¨ä»¥å¤ªåŠä¸­ï¼Œv é€šå¸¸æ˜¯27æˆ–28ï¼Œä½†ä¹Ÿå¯èƒ½å› é“¾ä¸Šä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚ä¸åŒçš„æµ‹è¯•ç½‘æˆ–ä¸»ç½‘ï¼‰è€Œæœ‰æ‰€ä¸åŒã€‚  
**signature**: è¿™æ˜¯å®é™…çš„ç­¾åï¼Œä»¥å­—èŠ‚ä¸²çš„å½¢å¼è¡¨ç¤ºã€‚å®ƒæ˜¯ç”±r, s, å’Œv ç»„åˆè€Œæˆçš„ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºåœ¨é“¾ä¸Šæˆ–é“¾ä¸‹éªŒè¯æ¶ˆæ¯çš„ç­¾åè€…ã€‚åœ¨ä»¥å¤ªåŠä¸­ï¼Œå®ƒé€šå¸¸æ˜¯ä¸€ä¸ª65å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­å‰32å­—èŠ‚æ˜¯rå€¼ï¼Œæ¥ä¸‹æ¥çš„32å­—èŠ‚æ˜¯så€¼ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯vå€¼ã€‚  

## éªŒè¯æŸä¸ªæ¶ˆæ¯
éªŒè¯æŸä¸ªæ¶ˆæ¯ï¼Œå®é™…ä¸Šå°±æ˜¯æ¥éªŒè¯å½“å‰è¿™ä¸ªæ¶ˆæ¯æ˜¯è°ç­¾åçš„ï¼Œæ‰€ä»¥æœ€åå¯ä»¥å¾—åˆ°ä¸€ä¸ªåœ°å€ã€‚ä¹Ÿæ˜¯å½“å‰ç§é’¥çš„åœ°å€ã€‚  
```python
print(f'ä»æ¶ˆæ¯ä¸­æ¢å¤çš„åœ°å€æ˜¯: {eth_test.eth.account.recover_message(msg, signature=signed_msg.signature)}')
```  
éœ€è¦æ³¨æ„çš„æ˜¯`recover_message`å‡½æ•°æ¥å—çš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯åŸæ¥çš„msgï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ç­¾åä¹‹åçš„ç”Ÿæˆçš„å¯¹è±¡ä¸­çš„`signature`å±æ€§ã€‚
## è§£å†³ä¹‹å‰çš„ç™»é™†é—®é¢˜
![img_1.png](img_1.png)  
åœ¨è¿™ä¸ªæ•°æ®åŒ…ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨çš„çŸ¥è¯†æ°´å¹³å¯ä»¥å¾ˆç¡®å®šä»–å‘é€çš„è¯·æ±‚å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå³æˆ‘ä»¬å¯¹msgè¿›è¡Œç­¾åï¼Œéšåå°†åœ°å€å’ŒæŒ‡çº¹æ‰“æˆjsonçš„è¯·æ±‚ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ­¤æ—¶ä¼šå“åº”æˆ‘ä»¬ä¸€ä¸ªjwtçš„token.  
é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ„å»ºè¿™ä¸ªç™»é™†è¯·æ±‚,å¹¶ä¸”æ‹¿åˆ°ç›¸å…³çš„tokenã€‚å¦‚æ­¤æœ´å®æ— åçš„æ“ä½œï¼Œæˆ‘ä¸€ä¸ªæœˆå‰å±…ç„¶ä¸ä¼šï¼Œæˆ‘çœŸğŸ¥¬  
```python
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",
        "Content-Type": "application/json",
        "Accept": "application/json, text/plain, */*"
    }
    url = "https://somehost/login?via=wallet"
    data = {
        "wallet_address": wallet_address,
        "signature":eth_test.eth.account.sign_message(msg, wallet_address1_pvk).signature
    }
    resp = requests.post(url=url,headers=headers,json=data)
    token = resp.json()["data"]["accessToken"]
```
æ¥ä¸‹æ¥çš„å†…å®¹å¾—ç©ºä¸€ä¸‹ï¼Œæˆ‘ä»¬å…ˆçœ‹æ™ºèƒ½åˆçº¦ï¼Œå†æ¥ç­¾åä¸æ™ºèƒ½åˆçº¦è¿›è¡Œäº¤äº’